---
title: "Area Level Model"
author: "Mamadou S Diallo, Ph.D"
date: today
format:
  html:
    theme: readable
    toc: true
    toc-depth: 3
    code-fold: false
execute:
  echo: true
  warning: false
  message: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## Overview

Small Area Estimation (SAE) refers to a set of statistical techniques used to produce reliable estimates for small geographic or demographic sub-populations, known as "small areas," where traditional survey methods may not provide sufficient data for accurate estimation. 

SAE methods leverage auxiliary information and statistical modeling to improve the precision of estimates for these small areas.

### Terminology 

**Direct estimator**. The survey estimates derived by only using the sample data. They can be design-based or model-based.

**Small Area**. A domain (area) for which a direct estimates of adequate precision cannot be produced.

**Borrow strength**. Use data from other small areas through the model and the auxiliary variables.

**Area-level Model**. The modeling is done at the (small) area level. 

**Unit-level Model**. The modeling is done at the individual (unit) level. 

### Overall Approach

- Use of auxiliary data to model variable of interest

- Generally, models from the generalized linear mixed models (GLMM) family are used 

- Small areas are used as random effects to model variation across areas and borrow strength

- Account for the survey design in the estimation of uncertainty 


### Prerequisites for Successfull SAE

- Availability of good quality auxiliary data correlated to the variable of interested

- Spend the time to explore modeling options and refine model candidates based on sound model selection and diagnosis techniques

- Access to good subject matter experts to guide the choice of data and models

- Use of cutting edge software solutions since SAE research is very active

- If possible, the survey can be designed to be more SAE friendly

### Examples of Auxiliary Data

- **Census data / Population Registries**. Censuses and population registries are often default choices for developing official SAE estimates. However, obtaining this information can be challenging outside of national statistical offices. 

- **Administrative records**. It may require a good administrative recording system. Popular program may provide better coverage of the population of interest. For example, tax data, social transfer program data, etc.

- **Large reference surveys**. For example, the American Community Survey (ACS) in the USA. See [https://www.census.gov/programs-surveys/acs](https://www.census.gov/programs-surveys/acs)

- **Geo-referenced and other big-data**. A large number of commercial and non-commercial sources are available for use as auxiliary information. For example, [DE Africa](https://docs.digitalearthafrica.org/en/latest/index.html), Satellite imagery from several other sources, transport networks data, cell-phone data, etc.


### Main Benefits of SAE

- Reduce the measures of uncertainty (MSEs, CVs, etc.)
- Increase the number of areas passing the quality thresholds
  - Allow for publication of statistics that would otherwise be suppressed
  - Permit the release of estimates at lower levels of aggregation
- Allow for the production of estimates for areas with no survey sample


### Examples of SAE Applications

- World Bank program for estimating poverty at the small area, see [https://www.worldbank.org/en/research/brief/software-for-poverty-mapping](https://www.worldbank.org/en/research/brief/software-for-poverty-mapping)

- UNFPA SAE program, see [https://www.unfpa.org/publications/small-area-estimation](https://www.unfpa.org/publications/small-area-estimation)

- Multiple SAE programs from countries
  - Small Area Income and Poverty Estimates (SAIPE) Program: [https://www.census.gov/programs-surveys/saipe.html](https://www.census.gov/programs-surveys/saipe.html)
  - U.S Bureau of Labor Statistics Local Area Unemployment Statistics [https://www.bls.gov/lau/](https://www.bls.gov/lau/)
  - SAE at Statistics Canada: [https://www150.statcan.gc.ca/n1/pub/12-001-x/2019001/article/00009-eng.htm](https://www150.statcan.gc.ca/n1/pub/12-001-x/2019001/article/00009-eng.htm)
  

### SAE4SDG

- United Nation’s Department of Economic and Social Affairs, under the guidance of the UN’s Intersecretariate Group on Household Surveys and the advice of several experts, developed SAE toolkit

- “Aims to help countries use SAE methods to improve Sustainable Development Goals for vulnerable population
groups” 

- Website: [https://unstats.un.org/wiki/display/SAE4SDG/](https://unstats.un.org/wiki/display/SAE4SDG/)

### Software for SAE 

A selected list of SAE software 

| Library | Language | Area | Unit |
|---------|----------|------|------|
| [sae](https://cran.r-project.org/web/packages/sae/index.html)    | R | Yes  | Yes  |
| [emdi](https://cran.r-project.org/web/packages/emdi/index.html)  | R | Yes  | Yes  |
| [rsae](https://cran.r-project.org/web/packages/rsae/index.html)  | R | Yes  | Yes  |
| [hbsae](https://cran.r-project.org/web/packages/hbsae/index.html)| R | Yes  | Yes  |
| [samplics](https://samplics.readthedocs.io/en/latest/)      | Python | Yes  | Yes  |
| [sae](https://github.com/pcorralrodas/SAE-Stata-Package)      | Stata | No  | Yes  |
| [FHSAE](https://ideas.repec.org/c/boc/bocode/s458495.html)      | Stata | Yes  | No  |
| [fayherriot](https://www.econstor.eu/bitstream/10419/206641/1/1681141345.pdf)      | Stata | Yes  | No  |
| [fayherriot](https://www.econstor.eu/bitstream/10419/206641/1/1681141345.pdf)      | Stata | Yes  | No  |

For a more complete list, visit [https://unstats.un.org/wiki/display/SAE4SDG/Software+packages](https://unstats.un.org/wiki/display/SAE4SDG/Software+packages) 

### Resources

- [Asian Development Bank:](https://www.adb.org/publications/small-area-estimation-guide-national-statistics-offices)
- [Bureau of Justice Statistics, USA:](https://bjs.ojp.gov/sites/g/files/xyckuh236/files/media/document/300580.pdf)
- [Demographic and Health Surveys (DHS) SAE:](https://dhsprogram.com/pubs/pdf/WP180/WP180.pdf)
- [Inter-Agency and Expert Group on SDG Indicators:](https://unstats.un.org/wiki/display/SAE4SDG/SAE4SDG)
- Rao, J. N. K., and Molina, I. Small-Area Estimation. Wiley, 2nd edition, 2015.





## Basic Area Level (Fay-Herriot) Model

The basic area level model, also known as Fay-Herriot, is given by 

&emsp;  &emsp; **Sampling model**: $\hat{\theta}_d = \theta_d  + e_d, \quad d=1, ...,m,$

&emsp;  &emsp; **Linking model**: $\theta_d = x_d^T \beta + b_d u_d,$

where 

&emsp; - $\theta_d$ is the population characteristic of interest,      
&emsp; - $\hat{\theta}_d$ is the direct estimate of $\theta_d$,         
&emsp; - $x_d$ is a $p$ x 1 vector of the area level covariates,   
&emsp; - $\beta = (\beta_1, ..., \beta_p)^T$ is $p$ x 1 vector of regression coefficients,    
&emsp; - $b_d$ are known positive constants,   
&emsp; - area effects $u_d \overset{iid}{\sim} N(0, \sigma_u^2)$,     
&emsp; - sampling errors $e_d \overset{ind}{\sim} N(0, \psi_d)$,    
&emsp; - $e_d$ and $u_d$ independents.

The sampling variances, $\psi_d$, are assumed to be known. However, this is not the case in real application. Hence, $\psi_d$ can be estimated using the sample.

### The EBLUP of the Basic Area Level Model

The basic area level model is a special case of the GLMM. Hence, the EBLUP is 

$$ \hat{\theta}_d^{EB} = \hat{\gamma}_d \hat{\theta}_d + (1-\hat{\gamma}) z_d^T \tilde{\beta},$$

where $$ \hat{\gamma}_d = \frac{\hat{\sigma}_v^2 b_d^2}{\psi_d + \hat{\sigma}_v^2 b_d^2}$$

and $\tilde{\beta}$ is the best linear unbiased estimator (BLUE) of $\beta$.

The EBLUP is a weighted average of the direct estimator $\hat{\theta}$ and the synthetic estimator $z_d^T \tilde{\beta}$.


### The MSE under the Basic Area Level Model

Following teh GLMM results, the MSE of the EBLUP has the form 

$$ mse_1(\hat{\theta}^{EB}) \approx g_1(\hat{\delta}) + g_2(\hat{\delta}) + g_3(\hat{\delta}) $$

$g_1(\delta)$ accounts for the estimation of $\theta$       
$g_2(\delta)$ accounts for the estimation of $\beta$     
$g_3(\delta)$ accounts for the estimation of $\delta$   

&nbsp;
&nbsp;
&nbsp;

&emsp; &emsp; &emsp; &emsp; Reference: Rao and Molina (2015), 2nd ed.,  Section 5.3

### ML Estimation of $\sigma_u^2$

The maximum likelihood (ML) estimator of $\sigma_u^2$ is given by 

$$ \sigma_u^{2(a+1)}  = \sigma_u^{2(a)} + [I(\sigma_u^{2(a)})]^{-1} s(\tilde{\beta}^{(a)}, \sigma_u^{2(a)})$$

where $$ I(\sigma_u^{2}) = \frac{1}{2} \sum_{d=1}^{m} \frac{b_d^4}{(\sigma_u^2 b_d^2 + \psi_d)^2} $$

and $$ s(\tilde{\beta}, \sigma_u^2) = -\frac{1}{2} \sum_{d=1}^{m} \frac{b_d^2}{\sigma_u^2 b_d^2 + \psi_d} + \frac{1}{2} \sum_{d=1}^{m} b_d^2 \frac{(\hat{\theta}_d - x_d^T \tilde{\beta})^2}{(\sigma_u^2 b_d^2 - \psi_d)^2}$$

### REML Estimation of $\sigma_u^2$

The restricted maximum likelihood (REML) estimator of $\sigma_u^2$ is given by 

$$ \sigma_u^{2(a+1)}  = \sigma_u^{2(a)} + [I_R(\sigma_u^{2(a)})]^{-1} s_R(\sigma_u^{2(a)}) $$

where $$ I_R(\sigma_u^{2}) = \frac{1}{2} tr(PBPB) $$

and $$ s_R(\sigma_u^2) = -\frac{1}{2} tr(PB) + \frac{1}{2} y^T PBP y$$

where $B = diag(b_1^2, ..., b_m^2)$ and P is defined as in the LMM model

### Variance Smoothing 

The design-based domain variance estimates, $\hat{V}(y_d)$, can be unstable. 

We can use the generalized variance function (GVF) to model the survey-based domain variances.

For example, we may fit the log-linear model $$ log(\hat{V}(y_d)) = b_0 + b_1y_d +b_2n_d + \epsilon $$

We can then predict the domain variances by 

$$ \hat{v}_d = exp\Big(\frac{\hat{\sigma}_A^2}{2}\Big) exp(\hat{b}_0 + \hat{b}_1y_d + \hat{b}_2n_d) $$

<!-- ## Parametric Bootstrap  -->

### **Practice** (1/5)

Let's practice the APIs of the R package emdi for the FH model

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}
install.packages("emdi")

library(emdi)

packageVersion("emdi")

```

Consult the package documentation at [https://cran.r-project.org/web/packages/emdi/refman/emdi.html](https://cran.r-project.org/web/packages/emdi/refman/emdi.html)

### **Practice** (2/5)

Loading Example Data

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

data("eusilcA_popAgg")
data("eusilcA_smpAgg")

# head(eusilcA_popAgg, 3) # Show the first 10 rows of the population dataset
# head(eusilcA_smpAgg, 3) # Show the first 10
```


### **Practice** (3/5)

Combining population and sample data for area-level modeling

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

combined_data <- emdi::combine_data(
  pop_data = eusilcA_popAgg,
  pop_domains = "Domain",
  smp_data = eusilcA_smpAgg,
  smp_domains = "Domain"
)

head(combined_data, 3)

```


### **Practice** (4/5)

Fitting the Fay-Herriot model with analytical MSE estimation

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

fh_std <- emdi::fh(
  fixed = Mean ~ cash + self_empl, 
  vardir = "Var_Mean",
  combined_data = combined_data, 
  domains = "Domain", 
  method = "reml",
  MSE = TRUE
)

summary(fh_std)

```

### **Practice** (5/5)

How to extract results from the fitted model object `fh_std`?

**Point Estimates**

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

head(fh_std$ind, 9)

```

**MSE Estimates**

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

head(fh_std$MSE, 9)

```

**Transformation**

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

fh_std$transformation

```

**Estimation Model**


```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

fh_std$model

```

## Fay-Herriot Extensions

- Several extensions to Fay-Herriot allow to account for time and spatial correlations

- Multiple outcomes can be modeled simultaneously using multivariate Fay-Herriot models

### Rao-Yu (Time Series) Model

&emsp;  &emsp;  $\hat{\theta}_{dt} = \textbf{x}_{dt}^T \beta + b_d u_d + \nu_{dt}  + e_{dt}, \quad t=1, ...,T  \text{ and } d=1, ...,m,$

where $\nu_{dt}$'s are assumed to follow a first-order autoregressive process within each area $d$, 

$$ \nu_{dt} = \rho\nu_{d, t-1} + \epsilon_{dt}, \quad |\rho| < 1$$ 

with $\epsilon_{dt} \overset{iid}{\sim} N(0, \sigma^2)$. The errors $e_{dt}$, $u_d$, and $d_t$ are assumed to be independent of each other. The condition $|\rho| < 1$ ensures stationarity of the times series. The stationarity assumption leads to 

$$ V(\nu_{dt}) = \frac{\sigma^2}{1-\rho^2}$$


### Spatial Model

The sampling model can be written as 

$$\bf{\hat{\theta}} = \bf{\theta} + \textbf{e}$$ 

with $\textbf{e}|\bf{\hat{\theta}} \sim \textrm{N}(\textbf{0}, \bf{\Psi})$, where the sampling error covariance matrix $\bf{\Psi}$ is known. Hence, the combined spatial model is

$$\bf{\hat{\theta}} = Z \bf{\beta} + \textbf{u} + \textbf{e}$$

As for the basic Fay-Herriot model, $\bf{\Psi}$ is replaced by the survey estimator $\hat{\bf{\Psi}}$ or a smoothed estimator. 

**Example: Spatial Fay-Herriot model**

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}
# Load proximity matrix
data("eusilcA_prox")

dim(eusilcA_prox)

head(eusilcA_prox[1:9, 1:9], 9)

```

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}
fh_spatial <- emdi::fh(
  fixed = Mean ~ cash + self_empl, 
  vardir = "Var_Mean",
  combined_data = combined_data, 
  domains = "Domain",
  method = "reml",
  correlation = "spatial", 
  corMatrix = eusilcA_prox, 
  MSE = TRUE,
  mse_type = "analytical"
)

summary(fh_spatial)
```

### Logit Model

In the case of binary data, the area level logit model can be written as

&emsp;  &emsp; **Sampling model**: $y_d | p_d, n_d \sim Binomial(n_d, p_d), \quad d=1, ...,m,$

&emsp;  &emsp; **Linking model**: $logit(p_{d}) = \textbf{x}_{d}^T \beta + u_d + e_{dj}, \quad d=1, ...,m,$

where 

- $y_d$ is the observed number of successes in area $d$, 
- $n_d$ is the number of trials in area $d$, and 
- $p_d$ is the true probability of success in area $d$. 

The area effects $u_d \overset{iid}{\sim} N(0, \sigma_u^2)$, and the sampling errors $e_{dj} \overset{ind}{\sim} N(0, \psi_d)$.



**Example: logit transformation of the dependent variable**

```{r echo=TRUE, message=FALSE, warning=FALSE, results='markup'}

data("eusilcA_smp")

emdi_direct <- emdi::direct(
  y = "eqIncome", 
  smp_data = eusilcA_smp,
  smp_domains = "district", 
  weights = "weight", 
  threshold = 11064.82,
  var = TRUE, 
  boot_type = "naive", 
  B = 50, 
  seed = 123, 
  X_calib = NULL,
  totals = NULL, 
  na.rm = TRUE
)

combined_data <- emdi::combine_data(
  pop_data = eusilcA_popAgg,
  pop_domains = "Domain",
  smp_data = data.frame(emdi_direct$ind[ , c("Domain", "Gini")],
                        Var_Gini = emdi_direct$MSE[ , c("Gini")]),
  smp_domains = "Domain"
)

fh_logit <- emdi::fh(
  fixed = Gini ~ cash + age_ben + rent + house_allow + self_empl,
  vardir = "Var_Gini", 
  combined_data = combined_data, 
  domains = "Domain",
  method = "ml", 
  transformation = "logit", 
  backtransformation = "bc",
  MSE = TRUE, 
  mse_type = "boot", 
  B = c(50, 0)
)


summary(fh_logit)
```


